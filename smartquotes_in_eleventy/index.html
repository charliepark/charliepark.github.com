<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Charlie Park’s tumblelog</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* General CSS for the blog */
a { color: inherit; text-decoration: none; }

blockquote {
  border-left: 2px solid #e6e6e6;
  margin: 0;
  padding-left: 1rem;
}

body {
  background-image: url('/images/arrow.webp');
  background-size: 200px 125px;
  background-position: 48.85% -2px;
  background-repeat: no-repeat;
  display: flex;
  flex-direction: column;
  font-family: 'Avenir Next', Avenir, system-ui, -apple-system, sans-serif;
  justify-content: space-between;
  line-height: 1.5;
  margin: 6rem 0 0;
  min-height: 100vh;
}

body.serif {
  font-family: Georgia, 'Times New Roman', Times, serif;
}

button {
  background: hsl(197, 100%, 30%);
  border: none;
  border-radius: 1rem;
  color: hsla(0, 0%, 100%, 0.7);
  font-family: inherit;
  font-size: .85em;
  padding: .075em 1em;
}

code {
  font-family: 'Monaco', monospace;
  font-size: .8em;
  background: #e6e6e6;
  border-radius: 4px;
  padding: 2px 3px;
}
pre code { border: none; padding: 0 }

footer {
  background: #464646;
  color: hsla(0, 0%, 100%, 0.8);
  margin-top: 5rem;
  padding: 1rem;
  text-align: center;
}

h1 { font-size: 2rem; line-height: 1.3; margin-top: 0.25em; }
header h1 { font-size: 4rem; margin-bottom: 0 }
.postbody h1,
.postbody h2,
.postbody h3 { padding-left: 1.2em; text-indent: -1.2em }

h2 { font-size: 1.5rem; margin: 1.5rem 0 0 }

h3 { font-size: 1.2rem; margin: 1.5rem 0 0 }

h4 { font-size: 1rem }

header { text-align: center }

html {
  color: hsla(0, 0%, 0%, 0.9)
}
html.darkmode {
  background: #272727;
  color: hsla(0, 0%, 100%, 0.7);
}

img { max-width: 100% }

main {
  flex-grow: 1;
  margin: 0 auto;
  max-width: 600px;
  width: 100%;
}

nav { padding: 1rem }

strong { font-weight: 600 }

/* Not supported anywhere yet, but in the spec */
p:has(> img) { text-align: center }

.callout_box { background: #ececec; border-radius: .25rem; padding: .5rem 1rem; }
.callout_box p:first-child { margin-top: 0 }
.callout_box p:last-child { margin-bottom: 0 }

.gray { color: #545454 }

.postbody { padding: 20px }
nav a, .postbody a { border-bottom: 1px solid #e6e6e6; color: hsl(197, 100%, 30%); font-weight: 600; text-decoration: none }
nav a { margin: .5rem }
.postbody a:hover { border-color: #c6c6c6 }

.smallcaps, .postdate, .poem h1 + p {
  font-size: .75em;
  letter-spacing: .8px;
  text-transform: uppercase;
}

.postdate {
  border-bottom: 1px solid #e6e6e6;
  display: block;
  margin-top: 4rem;
  text-align: right;
}
.postdate a { color: #545454; display: block; padding: 0 1rem }

/* Post-specific CSS */

.image { text-align: center }
.image img { margin-bottom: 1rem }
.image p { margin: 0 }

.poem .postbody{
  align-items: center;
  display: flex;
  flex-direction: column;
}
.poem h1 { margin-bottom: 0 }

.text {}

.quote .postbody { font-size: 2rem; }
.quote.long .postbody { font-size: 1.5rem; }
.quote.short .postbody { font-size: 3rem; line-height: 1.3 }
.quote.verylong .postbody { font-size: 1rem; }
.quote p { padding-left: 2rem }
.quote p:first-child { padding-left: 2rem; position: relative;}
.quote p:first-child::before { content: '“'; font-family: Georgia; font-size: 4rem; line-height: 3rem; position: absolute; top: 10px; left: 0; }
.quote p:last-child { font-size: 1rem; text-align: right }

.video iframe { width: 100% !important }



/* Minified code styling; https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css  */
code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:0 0;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}
  </style>
</head>
<body>
  <header>
    <h1><a href="/">Charlie Park!</a></h1>
    <div>(or, rather, his tumblelog)</div>
    <nav><a href="/">home</a><a href="/about">about me</a><a href="/projects">projects</a></nav>
  </header>
  <main>
    
<article class="text">
<time class="postdate" datetime="2020-10-05T07:00:00.000Z">
  <a href="">October 5, 2020</a>
</time>
<div class="postbody">
  <h1>Smartquotes in Eleventy</h1>
<aside style="background:#e5e5e5; border-radius: 1rem; padding: 1px 1rem;">
<p>This post will make a bit more sense if you read it in a serif font. You can do that by poking this button: <button id="serif_toggle">serif / sans</button></p>
</aside>
<script>
  const serifToggle = document.getElementById("serif_toggle");
  console.log(serifToggle);
  serifToggle.addEventListener("click", () => {
    console.log("clicked");
    document.body.classList.toggle("serif");
  });
</script>
<p>I’m working on turning this tumblelog into a more fully-fleshed-out tool that anyone can use to quickly spin up a tumblelog of their own, and one of the things I wanted to nail down was smartquotes.</p>
<p>So far, I’ve gone to the trouble of hand-typing all of the smartquotes in my posts. How nice would it be, though, if Eleventy could just <em>know</em> which quote to put down, and do it for you?</p>
<p>Before I get into that, a quick bit of background for those of you who aren’t typography nerds. As a caveat, I use the Nunjucks templating syntax, and this all works; if you try it in another templating framework, let me know how it goes.)</p>
<h2>Smart whatnow?</h2>
<p>So if you look on your keyboard, just to the left of your “return” key, you’ll see the key you’d press to add a single quotation mark (’) or, with the <code>Shift</code> key modifying it, a double quotation mark (”).</p>
<p>In programs like Google Docs, the software typically converts those into “smart” (or “curly”) quotes for you. Smart quotes are the traditional way you’d see quotes when set in type, like in a book, magazine, etc.</p>
<p>There’s a problem, though! By default, Eleventy doesn’t change your quotes in Markdown files to smartquotes. So, unless you wrote each quotation mark in manually (<code>option</code> + <code>[</code> for left double quote, <code>shift</code> + <code>option</code> + <code>[</code> for right double quote, plus a similar process for apostrophes), you’d be left with straight quotes.</p>
<p>I haven’t <em>minded</em> hand-writing them, but surely there’s an easier way?</p>
<h1>Horrors. How do we fix it?</h1>
<p>Thankfully, Eleventy lets us run custom filters, which can process the files we’re saving. We just have to create one that does what we want.</p>
<p>In our <code>.eleventy.js</code> file, we’ll add a new filter, called “smartquotes”. Before we add anything in, it looks like this:</p>
<pre class="language-js"><code class="language-js">eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token keyword">return</span> post<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre>
<p>And we’ll call it in our main template file (like <code>index.njk</code>) like this:</p>
<pre class="language-js"><code class="language-js"><span class="token operator">&lt;</span>main<span class="token operator">></span><br>  <span class="token punctuation">{</span><span class="token punctuation">{</span> content <span class="token operator">|</span> smartquotes <span class="token operator">|</span> safe <span class="token punctuation">}</span><span class="token punctuation">}</span><br><span class="token operator">&lt;</span><span class="token operator">/</span>main<span class="token operator">></span><br></code></pre>
<p>(Normally, it’d just say <code>content | safe</code>, without the <code>smartquotes</code> bit in the middle.)</p>
<p>Okay. Now we basically need to add some regular expressions to swap out our various quotation marks.</p>
<h3>Regular double quotes</h3>
<p>Nunjucks converts normal double quotes (that aren’t inside a <code>&lt;code&gt;</code> block) into <code>&amp;quot;</code>, so we’re going to want to add a find-and-replace regular expression looking for that string.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|^|>)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/&amp;quot;(\s|\p{P}|$)?/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>If you aren’t familiar with regular expressions, that syntax can look kind of strange. Here’s what it means:</p>
<p><code>(\s|&gt;|^)&amp;quot;</code> = Look for the string <code>&amp;quot;</code> preceded by either a whitespace character or an angle bracket, or that’s at the beginning of the line. We need the angle bracket one in there because even if the quote mark is at the beginning of the line as we read it, the code behind the scenes kicks the line off with a <code>&lt;p&gt;</code> or similar.</p>
<p>The second one — <code>&amp;quot;(\s|\p{P}|$)?</code> — is kind of the opposite. Find situations where <code>$quot;</code> is followed by a whitespace character or by a punctuation mark of some sort, or is at the end of its line. That <code>\p{P}</code> is the “punctuation” wildcard. Note that you need to add the <code>u</code> flag at the end of the regular expression (to the right of the second slash, after the <code>g</code>).</p>
<p>Okay, great. What do we do with those two <code>const</code>s?</p>
<p>We add them in to the return statement, calling <code>replace()</code> on the <code>post</code> string:</p>
<pre class="language-js"><code class="language-js">eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|>|^)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/&amp;quot;(\s|\p{P}|$)?/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> post<br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openDoubles<span class="token punctuation">,</span> <span class="token string">"$1“"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeDoubles<span class="token punctuation">,</span> <span class="token string">"”$1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>The <code>$1</code> in that <code>replace()</code> string is for <em>capture groups</em> in the regular expression. Note how the regular expressions looked like <code>(\s|&gt;|^)&amp;quot;</code>? The part inside the parentheses is what gets popped into the <code>$1</code> in the <code>replace()</code> parameter.</p>
<p>Okay, so! We got our double quotes taken care of.</p>
<h3>Regular single quotes</h3>
<p>Like the double quotes, we’ll need to put together some regular expressions to get the single quotes.</p>
<p>This should look familiar:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> openSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|>|^)'/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> closeSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/'(\s|\p{P}|$)?/g</span><span class="token punctuation">)</span>u<span class="token punctuation">;</span></code></pre>
<p>See if you can read through that line and figure out what each one does. If you need help, look up at the section before this.</p>
<p>The only difference on the <code>replace()</code> call is that we’ll use smart single quotes:</p>
<pre class="language-js"><code class="language-js"><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openSingles<span class="token punctuation">,</span> <span class="token string">"$1‘"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeSingles<span class="token punctuation">,</span> <span class="token string">"’$1"</span><span class="token punctuation">)</span></code></pre>
<p>So now our full filter looks like this:</p>
<pre class="language-js"><code class="language-js">eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|>|^)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/&amp;quot;(\s|\p{P}|$)?/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|>|^)'/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/'(\s|\p{P}|$)?/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> post<br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openDoubles<span class="token punctuation">,</span> <span class="token string">"$1“"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeDoubles<span class="token punctuation">,</span> <span class="token string">"”$1"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openSingles<span class="token punctuation">,</span> <span class="token string">"$1‘"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeSingles<span class="token punctuation">,</span> <span class="token string">"’$1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Okay, great. So that’s single and double quotes. We haven’t gotten apostrophes set, yet. Let’s do that next.</p>
<h3>Apostrophes</h3>
<p>Apostrophes are pretty straightforward. A “word boundary” (0-9, a-z, A-Z, or the underscore character), then an apostrophe, then another “word boundary”. Things like can’t, they’re, it’s, and so on.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> apostrophes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\b)'(\b)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Note the parentheses, which let us capture the values and drop them into our <code>replace()</code> function.</p>
<p>As before, we keep building up our string manipulation:</p>
<pre class="language-js"><code class="language-js">eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> apostrophes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\b)'(\b)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|>|^)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/&amp;quot;(\s|\p{P}|$)?/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|>|^)'/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/'(\s|\p{P}|$)?/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> post<br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>apostrophes<span class="token punctuation">,</span> <span class="token string">"$1’$2"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openDoubles<span class="token punctuation">,</span> <span class="token string">"$1“"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeDoubles<span class="token punctuation">,</span> <span class="token string">"”$1"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openSingles<span class="token punctuation">,</span> <span class="token string">"$1‘"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeSingles<span class="token punctuation">,</span> <span class="token string">"’$1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Are we good, then?</p>
<p>Haha, no, you sweet, summer child.</p>
<h3>Abbreviated years</h3>
<p>Believe it or not, the apostrophe in shortened years is supposed to point to the left. That is, the “pointy bit” of the quotation mark always points to the thing that got removed. So if you shorten “2020”, you’d want it to look like ’20, not ‘20.</p>
<p>So how do we do that?</p>
<p>Just like the apostrophes, we capture some values. This time we capture a single quote sandwiched between a whitespace character and a digit.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> years <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s)'(\d)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class="language-js"><code class="language-js"><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>years<span class="token punctuation">,</span> <span class="token string">"$1’$2"</span><span class="token punctuation">)</span></code></pre>
<p>And, at the risk of being repetitive, here’s what our <code>smartquotes</code> filter looks like at this point:</p>
<pre class="language-js"><code class="language-js">eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> apostrophes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\b)'(\b)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> years <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s)'(\d)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|>|^)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/&amp;quot;(\s|\p{P}|$)?/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|>|^)'/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/'(\s|\p{P}|$)?/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> post<br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>apostrophes<span class="token punctuation">,</span> <span class="token string">"$1’$2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>years<span class="token punctuation">,</span> <span class="token string">"$1’$2"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openDoubles<span class="token punctuation">,</span> <span class="token string">"$1“"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeDoubles<span class="token punctuation">,</span> <span class="token string">"”$1"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openSingles<span class="token punctuation">,</span> <span class="token string">"$1‘"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeSingles<span class="token punctuation">,</span> <span class="token string">"’$1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Okay, great! Surely there aren’t any edge cases?</p>
<p>Oh, but there are.</p>
<h3>Edge cases — slang and Hawaiʻi</h3>
<p>As we just saw in <code>years</code>, the “pointy bit” of the quotation mark points at the elided content.</p>
<p>When “them” gets cut down to “em”, or “it was” gets smushed into “twas”, we want the quotation marks pointing at the beginning of the word: ’cause, ’em, ’til, ’twas.</p>
<p>Fortunately, there aren’t <em>that</em> many special cases, so for now I’ve hardcoded them. Odds are good I’ve missed a few. Please feel free to ping me and let me know!</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> slang <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/'(cause|em|til|twas)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>We also have an interesting case where — in the Hawaiian language — the official name of their land is Hawaiʻi. The character in between the two <code>i</code>s is called an ‘okina, and it’s a diacritic that indicates a glottal stop. When writing an ‘okina, the “pointy bit” points up — instead of down — regardless of where it occurs in a word. (<a href="https://en.wikipedia.org/wiki/Hawaii#Etymology">You can read more on the ‘okina over at Wikipedia.</a>)</p>
<p>The ‘okina is technically present in many Hawaiian words, like Oʻahu or Kauaʻi. My assumption, though, is that if you are paying attention to ‘okinas, you’re going to be hardcoding them in anyway. This filter catches Hawaiʻi, but doesn’t attempt to catch all Hawaiian words with ‘okinas.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> hawaii <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/Hawai'i/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Okay, so where are we now?</p>
<pre class="language-js"><code class="language-js">eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> hawaii <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/Hawai'i/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> slang <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/'(cause|em|til|twas)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> apostrophes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\b)'(\b)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> years <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s)'(\d)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|>|^)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/&amp;quot;(\s|\p{P}|$)?/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|>|^)'/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/'(\s|\p{P}|$)?/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> post<br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>hawaii<span class="token punctuation">,</span> <span class="token string">"Hawaiʻi"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>slang<span class="token punctuation">,</span> <span class="token string">"’$1"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>apostrophes<span class="token punctuation">,</span> <span class="token string">"$1’$2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>years<span class="token punctuation">,</span> <span class="token string">"$1’$2"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openDoubles<span class="token punctuation">,</span> <span class="token string">"$1“"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeDoubles<span class="token punctuation">,</span> <span class="token string">"”$1"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openSingles<span class="token punctuation">,</span> <span class="token string">"$1‘"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeSingles<span class="token punctuation">,</span> <span class="token string">"’$1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>That’s basically it! Almost.</p>
<h3>A hack for stet quotes</h3>
<p>The one last thing I ran into when working up this filter was kind of meta: When writing about it on this blog, how do we prevent straight quotes in code blocks (like the one right above this) from getting switched to smart quotes?</p>
<p>There were two ways I could think of to approach this situation. One was to create a more complicated regex that involved some sort of multi-line lookbehind, which would probably be pretty fragile. The other was to create some sort of rule to make sure that — at the end of the filtering — some quotes could stay as straight quotes. I went with that one. (If you have other suggestions, I’m all ears!)</p>
<p>In the journalism world, when editing on paper, <code>stet</code> is the markup an editor uses that means “um, I suggested a change, but you should ignore that, and keep your copy as it is.” As in, I’m editing your newspaper article and I cross out a word, and then decide that the word was actually appropriate, I’d write “stet” next to my earlier edit.</p>
<p>We need a “stet” equivalent here.</p>
<p>Here it is.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> stetSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/stet'stet/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>And, in the filter, we’ll call it with this:</p>
<pre class="language-js"><code class="language-js"><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>stetSingles<span class="token punctuation">,</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Note how there are no capture groups in the regex. So if I’m writing a block of code in Markdown (like I’m doing in this post), and I want to make sure it renders with a straight quote, I wrap it in the literal text <code>stet</code>. So if I write <code>stet'stetthisstet'stet</code>, what gets rendered is <code>'this'</code> instead of <code>‘this’</code>.</p>
<p>That’s probably a little hard to read. But what it’s saying is that when the entire filter runs, the very last call will be to look for text in the post that has a <code>stet</code> followed by a <code>’</code> followed by a <code>stet</code>, and to change that whole string into a straightquote.</p>
<p>And with that, for now, we’ve got our filter.</p>
<h2>The final filter</h2>
<p>Here’s what goes in your .eleventy.js file:</p>
<pre class="language-js"><code class="language-js">  eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> hawaii <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/Hawai'i/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> slang <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/'(cause|em|til|twas)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> apostrophes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\b)'(\b)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> years <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s)'(\d)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|>|^)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/&amp;quot;(\s|\p{P}|$)?/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> openSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s|>|^)'/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> closeSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/'(\s|\p{P}|$)?/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> stetSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/stet'stet/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> post<br>      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>hawaii<span class="token punctuation">,</span> <span class="token string">"Hawaiʻi"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>slang<span class="token punctuation">,</span> <span class="token string">"’$1"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>apostrophes<span class="token punctuation">,</span> <span class="token string">"$1’$2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>years<span class="token punctuation">,</span> <span class="token string">"$1’$2"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openDoubles<span class="token punctuation">,</span> <span class="token string">"$1“"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeDoubles<span class="token punctuation">,</span> <span class="token string">"”$1"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openSingles<span class="token punctuation">,</span> <span class="token string">"$1‘"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeSingles<span class="token punctuation">,</span> <span class="token string">"’$1"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>stetSingles<span class="token punctuation">,</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>And, then, like I said before, the “content” part of your <code>index.njk</code> file should look like this:</p>
<pre class="language-js"><code class="language-js"><span class="token operator">&lt;</span>main<span class="token operator">></span><br>  <span class="token punctuation">{</span><span class="token punctuation">{</span> content <span class="token operator">|</span> smartquotes <span class="token operator">|</span> safe <span class="token punctuation">}</span><span class="token punctuation">}</span><br><span class="token operator">&lt;</span><span class="token operator">/</span>main<span class="token operator">></span><br></code></pre>
<h2>A few tests:</h2>
<p>Abbreviated years work: ’97, ’01, ’04, ’07.</p>
<p>Apostrophes and contractions work: I can’t wait to see if anyone uses this.</p>
<p>Quotes work: “I just don’t think I have it in me,” said the dog that definitely didn’t eat the bacon off the countertop, no siree.</p>
<p>Internal quotes work, even with odd punctuation: “She didn’t say ‘You did this’! She said ‘<em>Hugh</em> did this’!”</p>
<p>Oh, and thanks to how Nunjucks and Eleventy process HTML, if we have some hardcoded HTML with a class or an inline style — <span style="color: darkred; font-family: fantasy">like this one</span> — the quote marks inside the brackets won’t get messed up, and your HTML will still work as expected.</p>
<p>Quotes at the beginning of a line will work, too:<br>
“And your profession?” “Goodness.”</p>

</div>
</article>

  </main>
  <footer>
    <p>Hey there. I’m Charlie. I like adventures, friends, and adventures with friends.</p>
    <p>Would love for you to say hi! charlie@charliepark.org</p>
  </footer>
</body>
</html>

