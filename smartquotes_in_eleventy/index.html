<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Charlie Park’s tumblelog</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <header>
    <h1><a href="/">Charlie Park!</a></h1>
    <div>(or, rather, his tumblelog)</div>
    <nav><a href="/">home</a><a href="/about">about me</a><a href="/projects">projects</a></nav>
  </header>
  <main>
    
<article class="serif">
<time class="postdate" datetime="2020-10-05T07:00:00.000Z">
  <a href="">October 5, 2020</a>
</time>
<div class="postbody">
  <h1>Fun with RegExes (AKA: How to Get Smartquotes in Eleventy)</h1>
<aside style="background:#e5e5e5; border-radius: 1rem; padding: 1px 1rem;">
<p>Per my note the other day about <a href="/tutorials_over_libraries/">Tutorials Over Libraries</a>, I’ve got a runthrough of how I added smartquotes to Eleventy. I know regular expressions can be daunting and opaque, and I’d love to clarify what I did here. If anything in this is confusing, I promise it’s not you. Regexes are squirrelly. If you have thoughts, please let me know! Similarly, I’m eager to learn where I can improve with regexes. Let me know if you have feedback!</p>
<p>As a caveat, I use the Nunjucks templating library, and this all works with it. It might work in other templating libraries, but I haven’t tested it. If you try it in another library, please let me know how it goes!</p>
<p>I’ve set this post in a serif font so you can see the smartquotes more easily.</p>
</aside>
<p>I’m working on turning this tumblelog into a more fully-fleshed-out tool that anyone can use to quickly spin up a tumblelog of their own. One of the things I wanted to nail down was smartquotes.</p>
<p>Since — so far — this is just my personal blog, I’ve gone to the trouble of hand-typing all of the smartquotes in my posts. I know that’s a bit excessive. How nice would it be, though, if you could just write regular quotes in Markdown, and if Eleventy would just <em>know</em> which quote to put down, and do it for you?</p>
<p>Before I get into that, a quick bit of background for those of you who aren’t typography nerds.</p>
<h2>Smart whatnow?</h2>
<p>So if you look on your keyboard, just to the left of your <code>return</code> key, you’ll see the key you’d press to add a single quotation mark (') or, with the <code>shift</code> key modifying it, a double quotation mark (&quot;).</p>
<p>In programs like Google Docs, the software typically converts those into “smart” (or “curly”) quotes for you. Smart quotes are the traditional way you’d see quotes when set in type, like in a book, magazine, etc.</p>
<p>There’s a problem, though! By default, Eleventy doesn’t change your quotes in Markdown files to smartquotes. So, unless you wrote each quotation mark in manually (<code>option</code> + <code>[</code> for left double quote, <code>shift</code> + <code>option</code> + <code>[</code> for right double quote, plus a similar process for apostrophes), you’d be left with straight quotes.</p>
<p>I haven’t <em>minded</em> hand-writing them, but surely there’s an easier way?</p>
<h2>Horrors. How do we fix it?</h2>
<p>Thankfully, Eleventy lets us run custom filters, which can process the files we’re saving. We just have to create one that does what we want.</p>
<p>In our <code>.eleventy.js</code> file, we’ll add a new filter, called “smartquotes”. Before we add anything in, it looks like this:</p>
<pre class="language-js"><code class="language-js">eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token keyword">return</span> post<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>And we’ll call it in our main template file (like <code>index.njk</code>) like this:</p>
<pre class="language-js"><code class="language-js"><span class="token operator">&lt;</span>main<span class="token operator">></span><br>  <span class="token punctuation">{</span><span class="token punctuation">{</span> content <span class="token operator">|</span> smartquotes <span class="token operator">|</span> safe <span class="token punctuation">}</span><span class="token punctuation">}</span><br><span class="token operator">&lt;</span><span class="token operator">/</span>main<span class="token operator">></span><br></code></pre>
<p>(Normally, it’d just say <code>content | safe</code>, without the <code>smartquotes</code> bit in the middle.)</p>
<p>Okay. Now we basically need to add some regular expressions to swap out our various quotation marks.</p>
<h3>Regular “double” quotes</h3>
<p>Nunjucks converts normal double quotes (that aren’t inside a <code>&lt;code&gt;</code> block) into <code>&amp;quot;</code>, so we’re going to want to add a find-and-replace regular expression looking for that string.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*)(?&lt;=\s|>)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*“.*)&amp;quot;(?=(\s|\p{P}|&lt;))/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>If you aren’t familiar with regular expressions, that syntax can look kind of strange. Here’s what it means:</p>
<p><code>?&lt;=(…)</code>: This is a “lookbehind” command. Basically: make sure that the sequence inside the parentheses occurs before the thing we’re looking for.</p>
<p><code>&lt;(h|l|p[^r])</code>: This is the sequence inside the parentheses. We need to see an angle bracket with either an <code>h</code>, an <code>l</code>, or a <code>p</code> (but not <code>pr</code>, as we <em>don’t</em> want to match <code>&lt;pre&gt;</code> blocks). (The <code>h</code> is for <code>h1</code>s, <code>h2</code>s, etc. The <code>l</code> is for <code>label</code> and <code>li</code> elements. The <code>p</code> is for <code>p</code> tags. We can add more if we like, but these were a good starting point.) (I tried a negative lookbehind, but the variations I tried kept breaking my test cases, so I’ve kept it like this for now.)</p>
<p><code>.*</code>: There can be characters between the thing we’ve already said we’re looking for and the next part of the regex.</p>
<p><code>(?&lt;=\s|&gt;)</code>: Another lookbehind! This is what we need to see immediately before the thing we’re looking for. Either a whitespace character or a closing angle bracket. (Remember, Eleventy is just going to be parsing the text of the file, so it’ll treat it as a string, not as an HTML node.) By including this as a lookbehind, we simplify our <code>replace()</code> call, which we’ll get to in a second. (Otherwise, we’d need to include a “capture group” in the <code>replace()</code>. Don’t worry. We’ll get to capture groups in a second.</p>
<p><code>$quot;</code>: The thing we’re looking for!</p>
<p>Okay. That was <code>openDoubles</code>. What about <code>closeDoubles</code>?</p>
<p>Some of this might look familiar. Try to parse it before I tell you what’s what.</p>
<p><code>(?&lt;=“.*)&amp;quot;(?=(\s|\p{P}|&lt;))</code></p>
<p>Okay. Here’s what’s what.</p>
<p><code>(?&lt;=“.*)</code>: Another lookbehind. This time, we need to see an open quote <code>“</code> followed by any number of characters. (We know we’ll have open quotes available because we’ll run the <code>openQuotes</code> replacement before running the <code>closeQuotes</code> replacement.</p>
<p><code>&amp;quot;</code>: Again, the thing we’re looking for.</p>
<p><code>(?=(…))</code>: This is a “lookahead” command. The string of text needs to include whatever’s inside the parentheses, but only <em>after</em> the thing we’re looking for.</p>
<p><code>\s|\p{P}|&lt;</code>: This is what’s inside the lookahead section. Whitespace (<code>\s</code>), or a punctuation mark (<code>\p{P}</code>), or a left-hand angle bracket (<code>&lt;</code>). Note that for that <code>\p{P}</code> part to work, we need to tell the regex that we’re including some unicode instructions. We do that with the <code>u</code> flag at the end of it (look back up at the code block at the top of this section, and find the <code>/gu</code>.)</p>
<p>Okay, great. What do we do with those two <code>const</code>s?</p>
<p>We add them in to the return statement, calling <code>replace()</code> on the <code>post</code> string:</p>
<pre class="language-js"><code class="language-js">eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*)(?&lt;=\s|>)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*“.*)&amp;quot;(?=(\s|\p{P}|&lt;))/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> post<br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openDoubles<span class="token punctuation">,</span> <span class="token string">"“"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeDoubles<span class="token punctuation">,</span> <span class="token string">"”"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Okay, so! We got our double quotes taken care of.</p>
<h3>Regular ‘single’ quotes</h3>
<p>Like the double quotes, we’ll need to put together some regular expressions to get the single quotes.</p>
<p>This should look kind of familiar:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> openSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*)(?&lt;=\s|>)'/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> closeSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*‘.*)'(?=(\s|\p{P}|&lt;))/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>See if you can read through that line and figure out what each one does. If you need help, look up at the section before this.</p>
<p>It’s actually exactly the same, except we’re looking for the straight single quote <code>‘</code> instead of the string <code>&amp;quot;</code>.</p>
<p>The only difference on the <code>replace()</code> call is that we’ll use smart single quotes:</p>
<pre class="language-js"><code class="language-js"><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openSingles<span class="token punctuation">,</span> <span class="token string">"‘"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeSingles<span class="token punctuation">,</span> <span class="token string">"’"</span><span class="token punctuation">)</span></code></pre>
<p>So now our full filter looks like this:</p>
<pre class="language-js"><code class="language-js">eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*)(?&lt;=\s|>)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*“.*)&amp;quot;(?=(\s|\p{P}|&lt;))/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/((?&lt;=&lt;(h|l|p[^r]).*)(?&lt;=\s|>)|\n)'/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*‘.*)'(?=(\s|\p{P}|&lt;))/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> post<br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openDoubles<span class="token punctuation">,</span> <span class="token string">"“"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeDoubles<span class="token punctuation">,</span> <span class="token string">"”"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openSingles<span class="token punctuation">,</span> <span class="token string">"‘"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeSingles<span class="token punctuation">,</span> <span class="token string">"’"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Okay, great. So that’s single and double quotes. We haven’t gotten apostrophes set, yet. Let’s do that next.</p>
<h3>Apostrophes</h3>
<p>Apostrophes are pretty straightforward. A “word boundary” (0-9, a-z, A-Z, or the underscore character, represented by <code>\b</code>), then an apostrophe, then another “word boundary”. This will pick up things like can’t, they’re, it’s, and so on.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> apostrophes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*)\b'\b/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>We’re going to want to run the apostrophes <em>before</em> replacing the double and single quote replacements. We could probably do it after, but this feels cleaner to me.</p>
<p>As before, we keep building up our string manipulation:</p>
<pre class="language-js"><code class="language-js">eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> apostrophes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*)\b'\b/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*)(?&lt;=\s|>)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*“.*)&amp;quot;(?=(\s|\p{P}|&lt;))/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/((?&lt;=&lt;(h|l|p[^r]).*)(?&lt;=\s|>)|\n)'/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*‘.*)'(?=(\s|\p{P}|&lt;))/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> post<br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>apostrophes<span class="token punctuation">,</span> <span class="token string">"’"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openDoubles<span class="token punctuation">,</span> <span class="token string">"“"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeDoubles<span class="token punctuation">,</span> <span class="token string">"”"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openSingles<span class="token punctuation">,</span> <span class="token string">"‘"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeSingles<span class="token punctuation">,</span> <span class="token string">"’"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Are we good, then?</p>
<p>Not yet!</p>
<h3>Abbreviated years</h3>
<p>Believe it or not, the apostrophe in shortened years is supposed to point to the left. That is, the “pointy bit” of the quotation mark always points to the thing that got removed. So if you shorten “2020”, you’d want it to look like ’20, not ‘20.</p>
<p>So how do we do that?</p>
<p>We want to capture a single quote sandwiched between a whitespace character and a digit. There are two ways we could do this. First, let’s look at a “capture group”:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> years <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(\s)'(\d)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Those parentheses indicate “capture groups”. When we run the <code>replace()</code> function, we’ll use the capture groups to insert the proper values back in. <code>$1</code> is the first capture group’s contents. <code>$2</code> is the second.</p>
<pre class="language-js"><code class="language-js"><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>years<span class="token punctuation">,</span> <span class="token string">"$1’$2"</span><span class="token punctuation">)</span></code></pre>
<p>“But wait,” you say. “We didn’t pass in capture group variables for the “word boundaries” (<code>\b</code>) earlier. Why not?</p>
<p>It turns out that the <code>\b</code> marker doesn’t actually match any characters. It just marks that liminal space between the word and the not-word.</p>
<p>An alternate method is just like the earlier “lookbehind” and “lookahead” approaches:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> years <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=\s)'(?=\d)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>And the <code>.replace()</code> call would be just the smart quote — no capture group variables.</p>
<pre class="language-js"><code class="language-js"><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>years<span class="token punctuation">,</span> <span class="token string">"’"</span><span class="token punctuation">)</span></code></pre>
<p>We will definitely want to run that one before the <code>openSingles</code> replacement, so those quotes get switched over and aren’t caught by the later replacement.</p>
<p>At the risk of being repetitive, here’s what our <code>smartquotes</code> filter looks like at this point:</p>
<pre class="language-js"><code class="language-js">eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> apostrophes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*)\b'\b/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> years <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=\s)'(?=\d)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*)(?&lt;=\s|>)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*“.*)&amp;quot;(?=(\s|\p{P}|&lt;))/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/((?&lt;=&lt;(h|l|p[^r]).*)(?&lt;=\s|>)|\n)'/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*‘.*)'(?=(\s|\p{P}|&lt;))/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> post<br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>apostrophes<span class="token punctuation">,</span> <span class="token string">"’"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>years<span class="token punctuation">,</span> <span class="token string">"’"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openDoubles<span class="token punctuation">,</span> <span class="token string">"“"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeDoubles<span class="token punctuation">,</span> <span class="token string">"”"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openSingles<span class="token punctuation">,</span> <span class="token string">"‘"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeSingles<span class="token punctuation">,</span> <span class="token string">"’"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Okay, great! Surely there aren’t any edge cases?</p>
<p>Oh, but there are.</p>
<h3>Edge cases — slang and Hawaiʻi</h3>
<p>As we just saw in <code>years</code>, the “pointy bit” of the quotation mark points at the elided content.</p>
<p>When “them” gets cut down to “em”, or “it was” gets smushed into “twas”, we want the quotation marks pointing at the beginning of the word: ’cause, ’em, ’til, ’twas.</p>
<p>Fortunately, there aren’t <em>that</em> many special cases, so for now I’ve hardcoded them. Odds are good I’ve missed a few. Please feel free to ping me and let me know!</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> slang <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/'(cause|em|til|twas)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>We also have an interesting case where — in the Hawaiian language — the official name of their land is Hawaiʻi. The character in between the two <code>i</code>s is called an ‘okina, and it’s a diacritic that indicates a glottal stop. When writing an ‘okina, the “pointy bit” points up — instead of down — regardless of where it occurs in a word. (<a href="https://en.wikipedia.org/wiki/Hawaii#Etymology">You can read more on the ‘okina over at Wikipedia.</a>)</p>
<p>The ‘okina is technically present in many Hawaiian words, like Oʻahu or Kauaʻi, but it usually gets dropped when the words are being written in English. In fact, the actual name of the US state is “Hawaii” — no ‘okina. This filter catches Hawaiʻi, but doesn’t attempt to catch all Hawaiian words with ‘okinas. (My assumption is that if you’re paying attention to ‘okinas, you’re going to be hardcoding them in anyway.)</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> hawaii <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/Hawaiʻi/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>And with that, for now, we’ve got our filter.</p>
<h2>The final filter</h2>
<p>Here’s what goes in your .eleventy.js file:</p>
<pre class="language-js"><code class="language-js">eleventyConfig<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"smartquotes"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> hawaii <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/Hawaiʻi/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> slang <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/'(cause|em|til|twas)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> apostrophes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*)\b'\b/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> years <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=\s)'(?=\d)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*)(?&lt;=\s|>)&amp;quot;/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*“.*)&amp;quot;(?=(\s|\p{P}|&lt;))/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> openSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*)(?&lt;=\s|>)'/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> closeSingles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=&lt;(h|l|p[^r]).*‘.*)'(?=(\s|\p{P}|&lt;))/gu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> post<br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>hawaii<span class="token punctuation">,</span> <span class="token string">"Hawaiʻi"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>slang<span class="token punctuation">,</span> <span class="token string">"’$1"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>apostrophes<span class="token punctuation">,</span> <span class="token string">"’"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>years<span class="token punctuation">,</span> <span class="token string">"’"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openDoubles<span class="token punctuation">,</span> <span class="token string">"“"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeDoubles<span class="token punctuation">,</span> <span class="token string">"”"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openSingles<span class="token punctuation">,</span> <span class="token string">"‘"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>closeSingles<span class="token punctuation">,</span> <span class="token string">"’"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>And, then, like I said up top, the “content” part of your <code>index.njk</code> file should look something like this:</p>
<pre class="language-js"><code class="language-js"><span class="token operator">&lt;</span>main<span class="token operator">></span><br>  <span class="token punctuation">{</span><span class="token punctuation">{</span> content <span class="token operator">|</span> smartquotes <span class="token operator">|</span> safe <span class="token punctuation">}</span><span class="token punctuation">}</span><br><span class="token operator">&lt;</span><span class="token operator">/</span>main<span class="token operator">></span><br></code></pre>
<h2>A few tests:</h2>
<p>Abbreviated years work: ’97, ’01, ’04, ’07.</p>
<p>Apostrophes and contractions work: I can’t wait to see if anyone actually uses this. If you’ve got suggestions or improvements, please shoot me a note.</p>
<p>Quotes work: “I just don’t think I have it in me,” said the dog that definitely didn’t eat the bacon off the countertop, no siree.</p>
<p>“Quotes” should “work”: even when there are multiple “quotes” per “line”.</p>
<p>Internal quotes work, even with curious punctuation: “She didn’t say ‘<em>You</em> did this’! She said ‘<em>Hugh</em> did this’!”</p>
<p>‘single quotes’ ‘work’, at the ‘beginning’, ‘middle’, and ‘end’</p>
<p>“So do” “double” “quotes.”</p>
<pre>But not inside 'pre' blocks, or in multi-line code blocks:</pre>
<pre class="language-js"><code class="language-js"><span class="token operator">&lt;</span>code<span class="token operator">></span><br>  These should <span class="token operator">*</span>not<span class="token operator">*</span> be <span class="token string">"smart"</span><span class="token punctuation">.</span><br><span class="token operator">&lt;</span><span class="token operator">/</span>code<span class="token operator">></span></code></pre>
<p>Oh, and thanks to how Nunjucks and Eleventy process HTML, if we have some hardcoded HTML with a class or an inline style — <span class="highlight">like this one</span> — the quote marks inside the brackets won’t get messed up, and your HTML will still work as expected.</p>
</div>
</article>

  </main>
  <footer>
    <p>Hey there. I’m Charlie. I like adventures, friends, and adventures with friends.</p>
    <p>Would love for you to say hi! charlie@charliepark.org</p>
  </footer>
</body>
</html>

